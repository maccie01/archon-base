# Research Result: 01_JWT_PATTERNS


# JWT Patterns

Created: 2025-10-14

Last Updated: 2025-10-14

## When to Use JWT

JSON Web Tokens (JWT) are self-contained, stateless tokens ideal for distributed systems and SPAs. Use JWT when:

* You require scalable, stateless authentication without server-side session stores.
* Multiple microservices must validate identity without central session lookups.
* Single-page applications need to manage access and refresh tokens in frontends.

Choose session-based cookies for monolithic apps or strict revocation requirements.

## JWT Structure

A JWT consists of three Base64URL-encoded segments separated by dots:

1. **Header** : Algorithm and token type
2. **Payload** : Claims (registered, public, custom)
3. **Signature** : HMAC or RSA signature

Example decoded:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">json</div></div><div><span><code><span class="token token">// Header</span><span>
</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token property">"alg"</span><span class="token token operator">:</span><span></span><span class="token token">"HS256"</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token property">"typ"</span><span class="token token operator">:</span><span></span><span class="token token">"JWT"</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">// Payload</span><span>
</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token property">"sub"</span><span class="token token operator">:</span><span></span><span class="token token">"userId123"</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token property">"role"</span><span class="token token operator">:</span><span></span><span class="token token">"admin"</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token property">"iat"</span><span class="token token operator">:</span><span></span><span class="token token">1697265600</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token property">"exp"</span><span class="token token operator">:</span><span></span><span class="token token">1697269200</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">// Signature: HMACSHA256(header + "." + payload, secret)</span><span>
</span></code></span></div></div></div></pre>

## Generating JWTs

## Basic Token Generation

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span> jwt </span><span class="token token">from</span><span></span><span class="token token">'jsonwebtoken'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">interface</span><span></span><span class="token token">JWTPayload</span><span></span><span class="token token punctuation">{</span><span>
</span><span>  userId</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">;</span><span>
</span><span>  email</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">;</span><span>
</span><span>  role</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span>
<span></span><span class="token token">// HS256: symmetric secret</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span></span><span class="token token operator">=</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span class="token token operator">!</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token constant">REFRESH_TOKEN_SECRET</span><span></span><span class="token token operator">=</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">REFRESH_TOKEN_SECRET</span><span class="token token operator">!</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">generateAccessToken</span><span class="token token punctuation">(</span><span>payload</span><span class="token token operator">:</span><span> JWTPayload</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">// Short-lived: 15 minutes</span><span>
</span><span></span><span class="token token">return</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">sign</span><span class="token token punctuation">(</span><span>payload</span><span class="token token punctuation">,</span><span></span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    algorithm</span><span class="token token operator">:</span><span></span><span class="token token">'HS256'</span><span class="token token punctuation">,</span><span>
</span><span>    expiresIn</span><span class="token token operator">:</span><span></span><span class="token token">'15m'</span><span class="token token punctuation">,</span><span>
</span><span>    issuer</span><span class="token token operator">:</span><span></span><span class="token token">'your-app'</span><span class="token token punctuation">,</span><span>
</span><span>    audience</span><span class="token token operator">:</span><span></span><span class="token token">'your-app-client'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">generateRefreshToken</span><span class="token token punctuation">(</span><span>userId</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">// Long-lived: 7 days</span><span>
</span><span></span><span class="token token">return</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">sign</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> sub</span><span class="token token operator">:</span><span> userId </span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span></span><span class="token token constant">REFRESH_TOKEN_SECRET</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    algorithm</span><span class="token token operator">:</span><span></span><span class="token token">'HS256'</span><span class="token token punctuation">,</span><span>
</span><span>    expiresIn</span><span class="token token operator">:</span><span></span><span class="token token">'7d'</span><span class="token token punctuation">,</span><span>
</span><span>    issuer</span><span class="token token operator">:</span><span></span><span class="token token">'your-app'</span><span class="token token punctuation">,</span><span>
</span><span>    audience</span><span class="token token operator">:</span><span></span><span class="token token">'your-app-refresh'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## Custom Claims

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">generateAccessTokenWithClaims</span><span class="token token punctuation">(</span><span>
</span><span>  payload</span><span class="token token operator">:</span><span> JWTPayload</span><span class="token token punctuation">,</span><span>
</span><span>  extra</span><span class="token token operator">:</span><span> Record</span><span class="token token operator"><</span><span class="token token">string</span><span class="token token punctuation">,</span><span></span><span class="token token">unknown</span><span class="token token operator">></span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">sign</span><span class="token token punctuation">(</span><span>
</span><span></span><span class="token token punctuation">{</span><span></span><span class="token token operator">...</span><span>payload</span><span class="token token punctuation">,</span><span></span><span class="token token operator">...</span><span>extra </span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">{</span><span> algorithm</span><span class="token token operator">:</span><span></span><span class="token token">'HS256'</span><span class="token token punctuation">,</span><span> expiresIn</span><span class="token token operator">:</span><span></span><span class="token token">'15m'</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## Signing Algorithms

| Algorithm | Symmetric/Asymmetric | Pros                               | Cons                 |
| --------- | -------------------- | ---------------------------------- | -------------------- |
| HS256     | Symmetric            | Fast, simple                       | Shared secret key    |
| RS256     | Asymmetric           | Key rotation, no secret on clients | Slower, complex keys |

 **Recommendation** : Use RS256 for public APIs to avoid secret distribution.

## Validating JWTs

## Express.js Middleware

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> Request</span><span class="token token punctuation">,</span><span> Response</span><span class="token token punctuation">,</span><span> NextFunction </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'express'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> jwt</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> JwtPayload </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'jsonwebtoken'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">requireAuth</span><span class="token token punctuation">(</span><span>
</span><span>  req</span><span class="token token operator">:</span><span> Request</span><span class="token token punctuation">,</span><span>
</span><span>  res</span><span class="token token operator">:</span><span> Response</span><span class="token token punctuation">,</span><span>
</span><span>  next</span><span class="token token operator">:</span><span> NextFunction
</span><span></span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> authHeader </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>headers</span><span class="token token punctuation">.</span><span>authorization</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span>authHeader</span><span class="token token operator">?.</span><span class="token token">startsWith</span><span class="token token punctuation">(</span><span class="token token">'Bearer '</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Missing token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">const</span><span> token </span><span class="token token operator">=</span><span> authHeader</span><span class="token token punctuation">.</span><span class="token token">split</span><span class="token token punctuation">(</span><span class="token token">' '</span><span class="token token punctuation">)</span><span class="token token punctuation">[</span><span class="token token">1</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">try</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> payload </span><span class="token token operator">=</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">verify</span><span class="token token punctuation">(</span><span>
</span><span>      token</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span>
</span><span></span><span class="token token punctuation">)</span><span></span><span class="token token">as</span><span> JwtPayload</span><span class="token token punctuation">;</span><span>
</span><span>    req</span><span class="token token punctuation">.</span><span>user </span><span class="token token operator">=</span><span></span><span class="token token punctuation">{</span><span> id</span><span class="token token operator">:</span><span> payload</span><span class="token token punctuation">.</span><span>sub</span><span class="token token operator">!</span><span class="token token punctuation">,</span><span> role</span><span class="token token operator">:</span><span> payload</span><span class="token token punctuation">.</span><span>role</span><span class="token token operator">!</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">next</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span></span><span class="token token">catch</span><span></span><span class="token token punctuation">(</span><span>err</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>err </span><span class="token token">instanceof</span><span></span><span class="token token">jwt</span><span class="token token punctuation">.</span><span>TokenExpiredError</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Token expired'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Invalid token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## Error Handling

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// example usage in Express</span><span>
</span><span>app</span><span class="token token punctuation">.</span><span class="token token">use</span><span class="token token punctuation">(</span><span class="token token punctuation">(</span><span>err</span><span class="token token punctuation">,</span><span> req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">,</span><span> next</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>err</span><span class="token token punctuation">.</span><span>name </span><span class="token token operator">===</span><span></span><span class="token token">'JsonWebTokenError'</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Invalid token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">next</span><span class="token token punctuation">(</span><span>err</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Refresh Token Pattern

## Why Refresh Tokens?

Access tokens are short-lived, minimizing risk. Refresh tokens allow silent re-authentication without user credentials.

## Implementation

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> Router</span><span class="token token punctuation">,</span><span> Request</span><span class="token token punctuation">,</span><span> Response </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'express'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> generateAccessToken</span><span class="token token punctuation">,</span><span> generateRefreshToken </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./jwt'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> jwt </span><span class="token token">from</span><span></span><span class="token token">'jsonwebtoken'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> router </span><span class="token token operator">=</span><span></span><span class="token token">Router</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> refreshTokens </span><span class="token token operator">=</span><span></span><span class="token token">new</span><span></span><span class="token token">Set</span><span class="token token operator"><</span><span class="token token">string</span><span class="token token operator">></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span></span><span class="token token">// replace with persistent store</span><span>
</span>
<span>router</span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/auth/refresh'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token operator">:</span><span> Request</span><span class="token token punctuation">,</span><span> res</span><span class="token token operator">:</span><span> Response</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> token </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>cookies</span><span class="token token punctuation">.</span><span>refreshToken</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span>token </span><span class="token token operator">||</span><span></span><span class="token token operator">!</span><span>refreshTokens</span><span class="token token punctuation">.</span><span class="token token">has</span><span class="token token punctuation">(</span><span>token</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Invalid refresh token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">try</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> sub </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">verify</span><span class="token token punctuation">(</span><span>token</span><span class="token token punctuation">,</span><span></span><span class="token token constant">REFRESH_TOKEN_SECRET</span><span class="token token punctuation">)</span><span></span><span class="token token">as</span><span> jwt</span><span class="token token punctuation">.</span><span>JwtPayload</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> accessToken </span><span class="token token operator">=</span><span></span><span class="token token">generateAccessToken</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> userId</span><span class="token token operator">:</span><span> sub</span><span class="token token operator">!</span><span class="token token punctuation">,</span><span> email</span><span class="token token operator">:</span><span></span><span class="token token">''</span><span class="token token punctuation">,</span><span> role</span><span class="token token operator">:</span><span></span><span class="token token">''</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// rotation: revoke old, issue new</span><span>
</span><span></span><span class="token token">refreshTokens</span><span class="token token punctuation">.</span><span class="token token">delete</span><span class="token token punctuation">(</span><span>token</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> newRefreshToken </span><span class="token token operator">=</span><span></span><span class="token token">generateRefreshToken</span><span class="token token punctuation">(</span><span>sub </span><span class="token token">as</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>    refreshTokens</span><span class="token token punctuation">.</span><span class="token token">add</span><span class="token token punctuation">(</span><span>newRefreshToken</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">cookie</span><span class="token token punctuation">(</span><span class="token token">'refreshToken'</span><span class="token token punctuation">,</span><span> newRefreshToken</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> httpOnly</span><span class="token token operator">:</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">,</span><span> secure</span><span class="token token operator">:</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">,</span><span> sameSite</span><span class="token token operator">:</span><span></span><span class="token token">'lax'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> accessToken </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span></span><span class="token token">catch</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> error</span><span class="token token operator">:</span><span></span><span class="token token">'Invalid token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Revocation Strategies

* **In-memory/DB store** to track valid refresh tokens.
* **Rotation** : issue new refresh token on each use and revoke the old.
* **Blacklist** : store revoked tokens until expiry.

## Token Storage

## Comparison Table

| Storage         | XSS Risk | CSRF Risk | Persistence                       | Usage                                |
| --------------- | -------- | --------- | --------------------------------- | ------------------------------------ |
| httpOnly Cookie | Low      | High      | Browser session/persistent cookie | Use with CSRF tokens, SameSite=lax   |
| localStorage    | High     | Low       | Persistent across tabs            | Use with strict CSP and sanitization |

## Recommended Approach

* Store **access tokens** in memory or secure cookie with `SameSite=Strict`.
* Store **refresh tokens** in httpOnly, secure cookies.
* Use CSRF tokens for endpoints that read cookies.

## JWKS and Key Rotation

## JSON Web Key Sets

Serve a JWKS endpoint for RS256 public keys:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> Router </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'express'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> jwks </span><span class="token token">from</span><span></span><span class="token token">'jwks-rsa'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> router </span><span class="token token operator">=</span><span></span><span class="token token">Router</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> keyStore </span><span class="token token operator">=</span><span> jwks</span><span class="token token punctuation">.</span><span class="token token">expressMiddleware</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>  jwksUri</span><span class="token token operator">:</span><span></span><span class="token token">'https://your-domain.com/.well-known/jwks.json'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>router</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/.well-known/jwks.json'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> keys</span><span class="token token operator">:</span><span></span><span class="token token punctuation">[</span><span class="token token">/* public keys */</span><span class="token token punctuation">]</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Key Rotation

* Rotate keys by adding new keys to JWKS.
* Client libraries will fetch new keys automatically.
* Deprecate old keys only after all tokens signed with them expire.

## Security Best Practices

1. **Short-lived access tokens** (≤15 min).
2. **Use HTTPS** exclusively.
3. **Validate issuer** and **audience** claims.
4. **Store secrets** in environment variables/vaults.
5. **Rate-limit** login and token endpoints.
6. **Log minimal claims** (avoid PII).
7. **Monitor** failed validation rates for anomalies.
8. **Enforce CORS** and CSP policies.

## Common Vulnerabilities & Mitigations

## None Algorithm Attack

* **Issue** : `alg: "none"` accepted.
* **Mitigation** : Reject tokens with “none” algorithm; explicitly whitelist algorithms.

## Weak Signing Keys

* **Issue** : Short/secrets.
* **Mitigation** : Use 256+ bit secrets or use RS256 with 2048-bit keys.

## Missing Expiration Validation

* **Issue** : Accepts tokens without `exp`.
* **Mitigation** : Require and enforce `exp` in verification.

## Token Leakage in Logs/URLs

* **Issue** : Tokens in query strings or logs.
* **Mitigation** : Transmit tokens only in headers or cookies; scrub logs.

## JWT Confusion Attacks

* **Issue** : Swapping HS256/RS256.
* **Mitigation** : Enforce expected algorithm, separate secrets from public keys.

## Anti-Patterns

## ❌ DON'T: Store Sensitive Data in JWT Payload

Embedding PII or secrets makes tokens targets; tokens are stored client-side.

## ❌ DON'T: Use Long-lived Access Tokens

Long-lived tokens increase risk if compromised.

## ❌ DON'T: Skip Audience/Issuer Validation

Leaving these checks opens tokens to misuse across contexts.

## Testing JWT Implementation

## Unit Tests (Jest + Supertest)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span> request </span><span class="token token">from</span><span></span><span class="token token">'supertest'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> jwt </span><span class="token token">from</span><span></span><span class="token token">'jsonwebtoken'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> app </span><span class="token token">from</span><span></span><span class="token token">'../src/app'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">describe</span><span class="token token punctuation">(</span><span class="token token">'JWT Auth'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">it</span><span class="token token punctuation">(</span><span class="token token">'rejects invalid token'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">request</span><span class="token token punctuation">(</span><span>app</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/protected'</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">set</span><span class="token token punctuation">(</span><span class="token token">'Authorization'</span><span class="token token punctuation">,</span><span></span><span class="token token">'Bearer invalid'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>res</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toBe</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">it</span><span class="token token punctuation">(</span><span class="token token">'accepts valid token'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> token </span><span class="token token operator">=</span><span> jwt</span><span class="token token punctuation">.</span><span class="token token">sign</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> sub</span><span class="token token operator">:</span><span></span><span class="token token">'user1'</span><span class="token token punctuation">,</span><span> role</span><span class="token token operator">:</span><span></span><span class="token token">'user'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span></span><span class="token token constant">ACCESS_TOKEN_SECRET</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> expiresIn</span><span class="token token operator">:</span><span></span><span class="token token">'1h'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">request</span><span class="token token punctuation">(</span><span>app</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/protected'</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">set</span><span class="token token punctuation">(</span><span class="token token">'Authorization'</span><span class="token token punctuation">,</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">Bearer </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">token</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>res</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toBe</span><span class="token token punctuation">(</span><span class="token token">200</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## References

* RFC 7519: JSON Web Token (JWT) standard
* OWASP JWT Cheat Sheet
* Auth0 JWT Documentation
* jsonwebtoken npm package
* JWT.io Introduction
* OWASP Top 10 – Broken Authentication
