# Knowledge Organization System - Design Complete

**Date**: 2025-10-14
**Status**: ✅ Design Phase Complete - Ready for Implementation

---

## Overview

The two-layer knowledge organization system for Archon has been fully designed and documented. This system separates **global knowledge** (shared across all work) from **project-specific knowledge** (scoped to individual projects), with clear discernability for AI agents through MCP tools, organized UI navigation, and a robust tagging system.

---

## Delivered Documents

### 1. Architecture Analysis (`ARCHITECTURE_ANALYSIS.md`)
**Generated by**: codebase-analyst agent
**Lines**: 1,010

**Key Findings**:
- `archon_project_sources` junction table already exists - foundation for project-scoped knowledge
- Current system is flat and global - all sources shared
- Extension points identified in all layers (database, services, MCP, API, frontend)
- 4-phase migration strategy with no breaking changes

**Critical Insight**: Infrastructure for 2-layer organization already exists. Implementation requires adding optional `project_id` filtering to search/query operations.

### 2. Design Specification (`DESIGN_SPECIFICATION.md`)
**Generated by**: general-purpose design agent
**Lines**: 1,428

**Complete Design Includes**:
- Database schema changes (3 new columns, 2 new tables)
- 40+ seeded knowledge tags across 11 categories
- Enhanced MCP tools with scope parameters
- New API endpoints for knowledge management
- Tab-based UI structure (Global / Projects / Tags)
- Agent search strategies and workflow patterns
- 5-phase implementation plan with timelines

**Key Features**:
- Folder organization for project knowledge
- Auto-tagging service with URL and content pattern matching
- Backward-compatible design (existing tools continue working)
- Clear separation between global and project scopes

### 3. Implementation Checklist (`IMPLEMENTATION_CHECKLIST.md`)
**Lines**: 216

**Quick Reference** covering:
- Database changes (10 items)
- Backend services (8 items)
- API endpoints (10 items)
- MCP tools (7 items)
- Frontend components (15 items)
- Testing (10 items)
- Documentation (6 items)
- Deployment (8 items)

---

## Design Highlights

### Database Schema

**New Fields on `archon_sources`**:
```sql
knowledge_scope TEXT DEFAULT 'global' CHECK (knowledge_scope IN ('global', 'project'))
project_id UUID REFERENCES archon_projects(id) ON DELETE CASCADE
folder_id UUID REFERENCES archon_project_knowledge_folders(id) ON DELETE SET NULL
```

**New Tables**:
1. `archon_knowledge_tags` - Tag definitions with descriptions, categories, usage guidelines
2. `archon_project_knowledge_folders` - Organizational folders for project knowledge

**Constraints**:
- `knowledge_scope='project'` requires `project_id` (enforced)
- Unique folder names per project
- CASCADE delete on project removal

### Tagging System

**11 Tag Categories**:
1. framework (React, NextJS, FastAPI, Django, Express)
2. language (Python, TypeScript, JavaScript, Rust, Go)
3. architecture (Microservices, REST API, GraphQL, Event-driven, Monolith)
4. security (Authentication, Authorization, Encryption, Security best practices)
5. testing (Unit, Integration, E2E)
6. deployment (Docker, Kubernetes, CI/CD)
7. database (PostgreSQL, MongoDB, Redis, Vector search)
8. api (OpenAPI, WebSockets)
9. ui (Tailwind, Radix UI, Design system)
10. documentation (API reference, Tutorial, Architecture docs, Troubleshooting)
11. general (Catch-all)

**Tag Schema**:
- tag_name (unique identifier)
- category (one of 11 categories)
- description (clear explanation)
- usage_guidelines (when and how to use)
- color_hex (visual identifier)
- icon_name (UI display)
- usage_count (tracking popularity)

### MCP Tool Enhancements

**Enhanced Existing Tools**:
- `rag_get_available_sources(scope, project_id)` - Filter by scope
- `rag_search_knowledge_base(query, scope, project_id)` - Scope-aware search

**New Tools**:
- `rag_search_project_knowledge(query, project_id, folder_name)` - Project-specific search
- `rag_search_global_knowledge(query, tags)` - Global knowledge search
- `rag_list_project_folders(project_id)` - List project folders

### UI Structure

**Tab Navigation**:
```
┌─────────────────────────────────────────────────┐
│  Knowledge Base                                  │
│                                                  │
│  ┌───────────┬────────────┬───────────┐         │
│  │  Global   │  Projects  │   Tags    │         │
│  └───────────┴────────────┴───────────┘         │
│                                                  │
│  [Current Tab Content]                          │
│                                                  │
└─────────────────────────────────────────────────┘
```

**Global Tab**:
- Grid/list view of all global knowledge sources
- Filter by tags, knowledge_type
- Search bar for quick filtering
- "Add Global Knowledge" button

**Projects Tab**:
- Accordion/tree structure showing projects
- Each project expands to show folders
- Folders expand to show knowledge sources
- Visual hierarchy: Project > Folder > Source
- Drag-and-drop organization

**Tags Tab**:
- Tag index organized by category
- Each tag shows description, usage guidelines, usage count
- Click tag to see all sources with that tag
- Search tags by name or category

### Agent Search Strategy

**Decision Tree**:
```
Agent needs knowledge
    │
    ├─ Working on specific project?
    │   │
    │   ├─ YES → Search project knowledge first
    │   │   │
    │   │   ├─ Found relevant results? → Use project knowledge
    │   │   │
    │   │   └─ No relevant results? → Expand to global search
    │   │
    │   └─ NO → Search global knowledge only
    │
    └─ Need general/framework knowledge? → Global search with tags
```

**Template CLAUDE.md Updates**:
```markdown
## Knowledge Base Context

**Current Project**: {PROJECT_NAME}
**Project ID**: {PROJECT_ID}

### Search Guidelines

1. For project-specific questions (implementation details, custom code):
   rag_search_project_knowledge("authentication flow", "{PROJECT_ID}")

2. For framework/language questions (how React hooks work):
   rag_search_global_knowledge("React hooks", tags=["react"])

3. For folder-specific searches:
   rag_search_project_knowledge("API schema", "{PROJECT_ID}", folder_name="API Documentation")
```

---

## Implementation Phases

### Phase 1: Database Schema (Week 1)
- Create migration script
- Add scope and project tracking to archon_sources
- Create knowledge_tags table
- Create project_knowledge_folders table
- Seed standard tags
- Update existing sources to scope='global'

### Phase 2: Backend Services (Week 2)
- Update KnowledgeItemService with scope filtering
- Create KnowledgeFolderService for folder management
- Create KnowledgeTagService for tag operations
- Create AutoTaggingService for tag suggestions
- Add new API endpoints

### Phase 3: MCP Tool Updates (Week 3)
- Update existing tools with scope parameters
- Create new project-aware tools
- Test all scope combinations
- Update tool documentation

### Phase 4: Frontend UI (Week 4)
- Create tab navigation component
- Build Global/Projects/Tags views
- Update AddKnowledgeDialog with scope selection
- Create folder management dialogs
- Add comprehensive tests

### Phase 5: Integration & Testing (Week 5)
- End-to-end testing
- Performance testing with large knowledge bases
- Documentation updates
- User guide creation
- Migration guide for existing users

---

## Key Design Decisions

### 1. Scope Behavior
**Decision**: "All" shows everything (global + project), "Global" shows unlinked only, "Project" shows linked only

**Reasoning**: Maximum flexibility and clarity. Users can see everything at once or focus on specific scope.

### 2. Search Behavior
**Decision**: Search only project-linked sources by default when in project context, with toggle to expand to global

**Reasoning**: Project context implies you want project-relevant results. Prevents cognitive overload from unrelated results.

### 3. Linking Behavior
**Decision**: Any source can be linked to multiple projects (many-to-many)

**Reasoning**: Documentation is often relevant to multiple projects. No need to duplicate sources.

### 4. UI Organization
**Decision**: Both in global Knowledge view AND in Project detail view

**Reasoning**: Supports both top-down (find sources) and bottom-up (organize projects) workflows.

### 5. Default Behavior
**Decision**: New sources are global (unlinked) by default, with optional auto-link in project context

**Reasoning**: Encourages reusable knowledge base. Prevents accidental scoping.

---

## Success Metrics

### Technical Metrics
- All search functions support project filtering
- API response time < 200ms with project filter
- Zero breaking changes to existing APIs
- 100% test coverage for project-source operations

### User Experience Metrics
- Users can link sources to projects in < 3 clicks
- Project-scoped search returns relevant results
- Clear visual distinction between global and project knowledge
- No user confusion reported in first month

### Adoption Metrics
- 50%+ of users link at least one source to a project
- Average 5+ sources linked per project
- 80%+ of searches use project context when available
- MCP tools used with project context 40%+ of time

---

## Backward Compatibility

**No Breaking Changes**:
- All existing MCP tools continue to work without scope parameter
- Default behavior: search all knowledge (scope="all")
- Existing CLAUDE.md files don't need updates to function
- New features are opt-in
- All existing sources automatically set to scope='global'

---

## Performance Considerations

**Optimizations**:
- Indexed queries on project_id and scope
- Pre-fetch source_ids array before search
- Cache project → source_id mappings
- Use array parameter for bulk filtering
- Monitor query performance with Logfire

**Targets**:
- Scope filtering: <50ms for 1000+ sources
- Search with scope: <200ms
- Folder tree render: <100ms for 50 folders
- Tag index load: <50ms for 200 tags
- Auto-tagging: <100ms per source

---

## Next Steps

### Immediate Actions

1. **Review Design Documents** ✅ READY
   - Review ARCHITECTURE_ANALYSIS.md
   - Review DESIGN_SPECIFICATION.md
   - Review IMPLEMENTATION_CHECKLIST.md
   - Get approval from stakeholders

2. **Begin Phase 1: Database Schema**
   - Create migration file
   - Test on development database
   - Verify constraints and indexes
   - Seed standard tags

3. **Parallel Track: Documentation**
   - Update CLAUDE.md template
   - Create user guide
   - Document agent workflow patterns
   - Add MCP tool examples

### Timeline

**Estimated Duration**: 5 weeks (1 engineer)
**Complexity**: Medium (mostly additive, no major architectural changes)
**Risk**: Low (junction table already exists, changes are optional features)

**Week 1**: Database schema ✅ Design complete
**Week 2**: Backend services and API endpoints
**Week 3**: MCP tool updates
**Week 4**: Frontend UI implementation
**Week 5**: Integration testing and documentation

---

## Open Questions for User

1. **Folder Hierarchy**: Should we support nested folders (folders within folders)?
   - Recommendation: Start with single-level, add nesting in Phase 2 if needed

2. **Source Sharing**: Should sources be moveable between projects or only linkable?
   - Recommendation: Keep many-to-many linking (current design)

3. **Auto-Tagging**: Should auto-tagging be mandatory or optional?
   - Recommendation: Auto-suggest tags, user can accept/modify/reject

4. **Default Scope**: When adding knowledge from project context, should it auto-link?
   - Recommendation: Show "Link to this project?" prompt with Yes/No

---

## Files and Locations

**Design Documents**:
- `/Users/janschubert/tools/archon/knowledge-organization/ARCHITECTURE_ANALYSIS.md`
- `/Users/janschubert/tools/archon/knowledge-organization/DESIGN_SPECIFICATION.md`
- `/Users/janschubert/tools/archon/knowledge-organization/IMPLEMENTATION_CHECKLIST.md`
- `/Users/janschubert/tools/archon/knowledge-organization/SUMMARY.md` (this file)

**Key Code Locations** (for implementation):
- Database: `/Users/janschubert/tools/archon/supabase/migrations/`
- Backend Services: `/Users/janschubert/tools/archon/python/src/server/services/knowledge/`
- MCP Tools: `/Users/janschubert/tools/archon/python/src/mcp_server/features/rag/`
- API Routes: `/Users/janschubert/tools/archon/python/src/server/api_routes/`
- Frontend: `/Users/janschubert/tools/archon/archon-ui-main/src/features/knowledge/`

---

## Conclusion

The two-layer knowledge organization system design is **complete and ready for implementation**. All critical aspects have been thoroughly analyzed and documented:

✅ **Architecture Analysis** - Current system understood, extension points identified
✅ **Database Design** - Schema changes defined, migrations planned
✅ **Service Layer** - New services and updates specified
✅ **MCP Tools** - Enhanced and new tools designed with scope awareness
✅ **API Endpoints** - New and updated endpoints documented
✅ **UI Design** - Tab-based navigation with mockups and component specs
✅ **Agent Strategy** - Search patterns and CLAUDE.md templates
✅ **Implementation Plan** - 5 phases with clear deliverables
✅ **Testing Strategy** - Unit, integration, and E2E tests defined
✅ **Migration Plan** - Backward-compatible approach with rollback

The design leverages existing infrastructure (`archon_project_sources` junction table) and adds incremental features without breaking existing functionality. Users can gradually adopt project-scoped knowledge while maintaining full access to their global knowledge base.

**Ready to proceed with Phase 1: Database Schema implementation.**

---

*Created: 2025-10-14*
*Design Team: Archon Development*
*Status: Design Complete - Implementation Ready*
