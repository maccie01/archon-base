# Research Result: 06_SQL_INJECTION_PREVENTION


# SQL Injection Prevention Patterns for PostgreSQL with Drizzle ORM and Node.js

**Main takeaway:** Prevent SQL injection by using Drizzle ORM’s parameterized query builders, validating and sanitizing inputs, enforcing least-privilege database roles, and testing thoroughly. Never concatenate user input directly into SQL strings.

---

## 1. SQL Injection Fundamentals

## What Is SQL Injection?

SQL injection occurs when an attacker supplies malicious input that alters the structure of a SQL query, allowing unauthorized data access, modification, or deletion.

## How Attacks Work

* **Classic Example**

  <pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">sql</div></div><div><span><code><span class="token token">-- Vulnerable string concatenation</span><span>
  </span><span>query </span><span class="token token operator">=</span><span></span><span class="token token">"SELECT * FROM users WHERE username = '"</span><span></span><span class="token token operator">+</span><span> username </span><span class="token token operator">+</span><span></span><span class="token token">"';"</span><span>
  </span></code></span></div></div></div></pre>

  If `username = "admin' OR '1'='1"`, the query becomes:
  <pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">sql</div></div><div><span><code><span class="token token">SELECT</span><span></span><span class="token token operator">*</span><span></span><span class="token token">FROM</span><span> users </span><span class="token token">WHERE</span><span> username </span><span class="token token operator">=</span><span></span><span class="token token">'admin'</span><span></span><span class="token token operator">OR</span><span></span><span class="token token">'1'</span><span class="token token operator">=</span><span class="token token">'1'</span><span class="token token punctuation">;</span><span>
  </span></code></span></div></div></div></pre>

  Returning every user row.

## Types of SQL Injection

* **Classic** : Injecting within quotes to alter WHERE clauses.
* **Blind** : True/false queries without direct feedback (timing-based).
* **Second-order** : Malicious data stored in the database then executed later in a dynamic query.

## Real-World Breaches

* 2015 TalkTalk breach exploited a vulnerable form to extract customer data.
* Numerous CMS plugins have suffered SQL injection leading to data exposure.

---

## 2. Drizzle ORM Protection

Drizzle ORM automatically generates parameterized queries. It never interpolates values directly into SQL strings, eliminating classic injection risks.

## Parameterized Queries

* Drizzle compiles every `.where(eq(...))` into `WHERE column = $1` with a bound parameter.
* Example:

  <pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> eq </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
  </span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> users </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./schema'</span><span class="token token punctuation">;</span><span>
  </span>
  <span></span><span class="token token">const</span><span> user </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
  </span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
  </span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
  </span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>username</span><span class="token token punctuation">,</span><span> username</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token">// Safe parameterized</span><span>
  </span><span></span><span class="token token punctuation">.</span><span class="token token">limit</span><span class="token token punctuation">(</span><span class="token token">1</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
  </span></code></span></div></div></div></pre>

  Generated SQL:
  <pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">sql</div></div><div><span><code><span class="token token">SELECT</span><span></span><span class="token token operator">*</span><span></span><span class="token token">FROM</span><span> users </span><span class="token token">WHERE</span><span> username </span><span class="token token operator">=</span><span> $</span><span class="token token">1</span><span></span><span class="token token">LIMIT</span><span></span><span class="token token">1</span><span class="token token punctuation">;</span><span>
  </span></code></span></div></div></div></pre>

  (`$1` binds `username` securely.)

## Query Building Safety

* All Drizzle query builder methods (`.where()`, `.join()`, `.orderBy()`) accept column references and values separately.
* Injection via dynamic table or column names must be avoided or validated (see Section 6).

## Raw SQL Queries

* Only use `sql\``` for fragments that cannot be expressed in the builder.
* NEVER interpolate untrusted input directly in raw SQL.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> sql </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">// Safe: parameter binding in sql`` template</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span>
</span><span>  sql</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">users</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string"> WHERE </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">users</span><span class="token token template-string interpolation punctuation">.</span><span class="token token template-string interpolation">id</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string"> = </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">userId</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">// ❌ Unsafe – building raw string</span><span>
</span><span>db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM users WHERE id = </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">userId</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## 3. Parameterized Queries

## What Are Parameterized Queries?

Queries in which placeholders (`$1`, `$2`, etc.) are used instead of injecting literal values directly into SQL strings.

## Prevention Mechanism

* Database drivers parse SQL and parameters separately, disallowing user input from altering query structure.

## Performance Benefits

* Plan caching: The database can reuse execution plans for parameterized queries, improving performance.

## Example

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// Safe single-parameter query</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> eq </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> activeUsers </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">,</span><span></span><span class="token token">'active'</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## 4. Input Validation

Validate inputs before passing to queries. Combine client- and server-side validation.

## Whitelist vs. Blacklist

* **Whitelist** : Accept only known-good characters or formats.
* **Blacklist** : Reject known-bad patterns (less reliable).

## Type Checking

Leverage TypeScript and Zod to enforce data shapes:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> z </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'zod'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> userQuerySchema </span><span class="token token operator">=</span><span> z</span><span class="token token punctuation">.</span><span class="token token">object</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>  username</span><span class="token token operator">:</span><span> z</span><span class="token token punctuation">.</span><span class="token token">string</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">min</span><span class="token token punctuation">(</span><span class="token token">3</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">max</span><span class="token token punctuation">(</span><span class="token token">50</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">regex</span><span class="token token punctuation">(</span><span class="token token regex-delimiter">/</span><span class="token token regex-source language-regex">^[a-zA-Z0-9_]+$</span><span class="token token regex-delimiter">/</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span>  status</span><span class="token token operator">:</span><span> z</span><span class="token token punctuation">.</span><span class="token token">enum</span><span class="token token punctuation">(</span><span class="token token punctuation">[</span><span class="token token">'active'</span><span class="token token punctuation">,</span><span class="token token">'inactive'</span><span class="token token punctuation">,</span><span class="token token">'suspended'</span><span class="token token punctuation">]</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">optional</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/api/users'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> username</span><span class="token token punctuation">,</span><span> status </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> userQuerySchema</span><span class="token token punctuation">.</span><span class="token token">parse</span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Proceed with safe query...</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## 5. Least Privilege Database Access

Applying the principle of least privilege reduces impact if credentials leak.

## Principle of Least Privilege

* Grant each service account only the minimum required privileges (SELECT, INSERT, UPDATE) on specific tables.

## Database User Permissions

* Create separate roles for read-only operations vs. write operations.
* Avoid superuser or admin credentials in application code.

## Connection Pooling Security

* Use pooling libraries (e.g. pg-pool) with dedicated low-privilege accounts.
* Rotate credentials regularly.

## Service Account Best Practices

* Store credentials securely (e.g. environment variables, vault).
* Monitor and audit database access logs.

---

## 6. Common Vulnerabilities

## String Concatenation in Queries

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// ❌ VULNERABLE</span><span>
</span><span></span><span class="token token">const</span><span> q </span><span class="token token operator">=</span><span></span><span class="token token">"SELECT * FROM users WHERE name = '"</span><span></span><span class="token token operator">+</span><span> name </span><span class="token token operator">+</span><span></span><span class="token token">"'"</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span>q</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Dynamic Table/Column Names

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// SECURITY RISK: uncontrolled interpolation</span><span>
</span><span></span><span class="token token">const</span><span> table </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>table</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">table</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

 **Safe pattern** : Whitelist the table name.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">const</span><span> allowed </span><span class="token token operator">=</span><span></span><span class="token token punctuation">{</span><span> users</span><span class="token token punctuation">,</span><span> posts </span><span class="token token punctuation">}</span><span></span><span class="token token">as</span><span></span><span class="token token">const</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> tbl </span><span class="token token operator">=</span><span> allowed</span><span class="token token punctuation">[</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>table </span><span class="token token">as</span><span></span><span class="token token">keyof</span><span></span><span class="token token">typeof</span><span> allowed</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Now use tbl reference in Drizzle builder.</span><span>
</span></code></span></div></div></div></pre>

## LIKE Clauses

Always parameterize the pattern; Drizzle’s `like` helper escapes special characters.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> like </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> term </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>search</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">like</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>name</span><span class="token token punctuation">,</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">%</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">term</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">%</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## ORDER BY Clauses

Unvalidated column names in `ORDER BY` enable injection.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// ❌ VULNERABLE</span><span>
</span><span></span><span class="token token">const</span><span> col </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>sort</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">orderBy</span><span class="token token punctuation">(</span><span>col</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

 **Safe pattern** :

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">const</span><span> sortFields </span><span class="token token operator">=</span><span></span><span class="token token punctuation">{</span><span> name</span><span class="token token operator">:</span><span> users</span><span class="token token punctuation">.</span><span>name</span><span class="token token punctuation">,</span><span> createdAt</span><span class="token token operator">:</span><span> users</span><span class="token token punctuation">.</span><span>createdAt </span><span class="token token punctuation">}</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> order </span><span class="token token operator">=</span><span> sortFields</span><span class="token token punctuation">[</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>sort </span><span class="token token">as</span><span></span><span class="token token">keyof</span><span></span><span class="token token">typeof</span><span> sortFields</span><span class="token token punctuation">]</span><span></span><span class="token token operator">||</span><span> users</span><span class="token token punctuation">.</span><span>id</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">orderBy</span><span class="token token punctuation">(</span><span>order</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Second-Order SQL Injection

Occurs when malicious input is stored and later interpolated unescaped. Always parameterize on retrieval as well.

---

## 7. Safe Patterns

## Using Drizzle ORM Query Builders

Leverage built-in methods—never roll your own string concatenation.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// Safe CRUD with Drizzle</span><span>
</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">update</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">set</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> status</span><span class="token token operator">:</span><span></span><span class="token token">'active'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>id</span><span class="token token punctuation">,</span><span> userId</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Handling Dynamic Filters

Compose conditions in an array, then apply `.where(and(...))`.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">function</span><span></span><span class="token token">buildFilters</span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> conds </span><span class="token token operator">=</span><span></span><span class="token token punctuation">[</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span> conds</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">,</span><span> filters</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">.</span><span>createdAfter</span><span class="token token punctuation">)</span><span> conds</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token">gte</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>createdAt</span><span class="token token punctuation">,</span><span> filters</span><span class="token token punctuation">.</span><span>createdAfter</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span> conds</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">?</span><span></span><span class="token token">and</span><span class="token token punctuation">(</span><span class="token token operator">...</span><span>conds</span><span class="token token punctuation">)</span><span></span><span class="token token operator">:</span><span></span><span class="token token">undefined</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">buildFilters</span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Safe LIKE Queries

Use the `like` helper:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">like</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>email</span><span class="token token punctuation">,</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">%</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">search</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">%</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span>
</span></code></span></div></div></div></pre>

## Safe ORDER BY Implementation

Map permitted sort keys to column references.

---

## 8. Testing for SQL Injection

## Manual Testing

* Supply single quotes and SQL fragments in input fields to detect vulnerabilities.
* Test blind injections with timing delays (e.g., `'; SELECT pg_sleep(5)--`).

## Automated Tools

* **SQLMap** : Open-source tool to scan for injection points automatically.
* **npm sql-injection-tester** : Lightweight scanners for Node.js.

## Unit Testing Database Queries

Mock the database and verify parameter binding:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> jest </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'@jest/globals'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> db </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./db'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> getUserByName </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./userService'</span><span class="token token punctuation">;</span><span>
</span><span>jest</span><span class="token token punctuation">.</span><span class="token token">spyOn</span><span class="token token punctuation">(</span><span>db</span><span class="token token punctuation">,</span><span></span><span class="token token">'select'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span></span><span class="token token">getUserByName</span><span class="token token punctuation">(</span><span class="token token">"admin'; DROP TABLE users;--"</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>db</span><span class="token token punctuation">.</span><span>select</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toHaveBeenCalledWith</span><span class="token token punctuation">(</span><span>
</span><span>  expect</span><span class="token token punctuation">.</span><span class="token token">objectContaining</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> name</span><span class="token token operator">:</span><span></span><span class="token token">'users'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span></span><span class="token token">// ensures builder usage rather than raw string</span><span>
</span></code></span></div></div></div></pre>

---

## Appendix: Code Examples

## 1. Unsafe SQL (String Concatenation)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">// ❌ VULNERABLE - NEVER do this</span><span>
</span><span></span><span class="token token">const</span><span> username </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">.</span><span>username</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> query </span><span class="token token operator">=</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM users WHERE username = '</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">username</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">'</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span>query</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Attack: username = "admin' OR '1'='1"</span><span>
</span></code></span></div></div></div></pre>

## 2. Safe with Drizzle ORM

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> eq </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> users </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./schema'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> user </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>username</span><span class="token token punctuation">,</span><span> username</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token">// Safe parameter</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">limit</span><span class="token token punctuation">(</span><span class="token token">1</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 3. Dynamic Filters (Safe)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> and</span><span class="token token punctuation">,</span><span> eq</span><span class="token token punctuation">,</span><span> gte</span><span class="token token punctuation">,</span><span> lte </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">function</span><span></span><span class="token token">buildFilters</span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> conds </span><span class="token token operator">=</span><span></span><span class="token token punctuation">[</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span> conds</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">,</span><span> filters</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">.</span><span>createdAfter</span><span class="token token punctuation">)</span><span> conds</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token">gte</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>createdAt</span><span class="token token punctuation">,</span><span> filters</span><span class="token token punctuation">.</span><span>createdAfter</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>filters</span><span class="token token punctuation">.</span><span>before</span><span class="token token punctuation">)</span><span> conds</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token">lte</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>createdAt</span><span class="token token punctuation">,</span><span> filters</span><span class="token token punctuation">.</span><span>before</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span> conds</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">?</span><span></span><span class="token token">and</span><span class="token token punctuation">(</span><span class="token token operator">...</span><span>conds</span><span class="token token punctuation">)</span><span></span><span class="token token operator">:</span><span></span><span class="token token">undefined</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span>
<span></span><span class="token token">const</span><span> results </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">buildFilters</span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 4. LIKE Queries (Safe)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> like </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> term </span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">.</span><span>search</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> matches </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">like</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>name</span><span class="token token punctuation">,</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">%</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">term</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">%</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 5. Raw SQL (When Necessary)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> sql </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">// ✅ Safe interpolation with sql`` and bindings</span><span>
</span><span></span><span class="token token">const</span><span> byId </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span>
</span><span>  sql</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">users</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string"> WHERE </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">users</span><span class="token token template-string interpolation punctuation">.</span><span class="token token template-string interpolation">id</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string"> = </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">userId</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">// ❌ Unsafe: raw string interpolation</span><span>
</span><span>db</span><span class="token token punctuation">.</span><span class="token token">execute</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">SELECT * FROM users WHERE id = </span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">userId</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 6. Input Validation with Zod

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> z </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'zod'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> eq </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'drizzle-orm'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> users </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'./schema'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">const</span><span> querySchema </span><span class="token token operator">=</span><span> z</span><span class="token token punctuation">.</span><span class="token token">object</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>  username</span><span class="token token operator">:</span><span> z</span><span class="token token punctuation">.</span><span class="token token">string</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">min</span><span class="token token punctuation">(</span><span class="token token">3</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">max</span><span class="token token punctuation">(</span><span class="token token">30</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">regex</span><span class="token token punctuation">(</span><span class="token token regex-delimiter">/</span><span class="token token regex-source language-regex">^[a-zA-Z0-9_]+$</span><span class="token token regex-delimiter">/</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span>  email</span><span class="token token operator">:</span><span> z</span><span class="token token punctuation">.</span><span class="token token">string</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">email</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">optional</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/api/users'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> username</span><span class="token token punctuation">,</span><span> email </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> querySchema</span><span class="token token punctuation">.</span><span class="token token">parse</span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Safe query</span><span>
</span><span></span><span class="token token">const</span><span> user </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> db
</span><span></span><span class="token token punctuation">.</span><span class="token token">select</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">where</span><span class="token token punctuation">(</span><span class="token token">eq</span><span class="token token punctuation">(</span><span>users</span><span class="token token punctuation">.</span><span>username</span><span class="token token punctuation">,</span><span> username</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">limit</span><span class="token token punctuation">(</span><span class="token token">1</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span>user</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

**Follow these patterns to ensure all database operations are immune to SQL injection.**
