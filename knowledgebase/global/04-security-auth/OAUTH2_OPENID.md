# Research Result: 13_OAUTH2_OPENID


# OAuth2 & OpenID Connect Patterns

Created: 2025-10-14

Last Updated: 2025-10-14

## Overview

OAuth 2.0 is an authorization framework allowing applications to obtain limited access to user resources. OpenID Connect (OIDC) is an authentication layer on OAuth 2.0 that issues ID tokens. This document covers flows, token types, PKCE, social login, introspection, security considerations, and testing patterns in Node.js/Express.

## Table of Contents

* When to Use OAuth2 vs OIDC
* OAuth 2.0 Grant Types
  * Authorization Code Flow
  * Implicit Flow
  * Client Credentials Flow
* OpenID Connect Fundamentals
  * ID Token vs Access Token vs Refresh Token
* PKCE for Public Clients
* Social Login Integration
  * Google OAuth2 Example
  * GitHub OAuth2 Example
* Token Introspection & Revocation
* Common OAuth2 Vulnerabilities & Mitigations
* Testing OAuth2/OIDC Implementations
* Anti-Patterns

---

## When to Use OAuth2 vs OIDC

* **OAuth 2.0** : Authorization framework to grant scoped access to APIs without sharing credentials.
* **OIDC** : Authentication protocol issuing ID tokens (JWT) containing user identity claims.

  Use OAuth 2.0 when you need scoped resource access; add OIDC when you also need standardized user authentication.

---

## OAuth 2.0 Grant Types

## Authorization Code Flow

Secure server-side flow for web apps.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">// 1. Redirect user to authorize endpoint</span><span>
</span><span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/login'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> params </span><span class="token token operator">=</span><span></span><span class="token token">new</span><span></span><span class="token token">URLSearchParams</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    response_type</span><span class="token token operator">:</span><span></span><span class="token token">'code'</span><span class="token token punctuation">,</span><span>
</span><span>    client_id</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_ID</span><span class="token token punctuation">,</span><span>
</span><span>    redirect_uri</span><span class="token token operator">:</span><span></span><span class="token token constant">REDIRECT_URI</span><span class="token token punctuation">,</span><span>
</span><span>    scope</span><span class="token token operator">:</span><span></span><span class="token token">'openid profile email'</span><span class="token token punctuation">,</span><span>
</span><span>    state</span><span class="token token operator">:</span><span></span><span class="token token">generateState</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">redirect</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation constant">AUTHORIZATION_ENDPOINT</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">?</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">params</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">// 2. Handle callback</span><span>
</span><span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/callback'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> code</span><span class="token token punctuation">,</span><span> state </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Validate state...</span><span>
</span><span></span><span class="token token">const</span><span> tokenRes </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">fetch</span><span class="token token punctuation">(</span><span class="token token constant">TOKEN_ENDPOINT</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    method</span><span class="token token operator">:</span><span></span><span class="token token">'POST'</span><span class="token token punctuation">,</span><span>
</span><span>    headers</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span></span><span class="token token string-property property">'Content-Type'</span><span class="token token operator">:</span><span></span><span class="token token">'application/x-www-form-urlencoded'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span>    body</span><span class="token token operator">:</span><span></span><span class="token token">new</span><span></span><span class="token token">URLSearchParams</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>      grant_type</span><span class="token token operator">:</span><span></span><span class="token token">'authorization_code'</span><span class="token token punctuation">,</span><span>
</span><span>      code</span><span class="token token operator">:</span><span> code </span><span class="token token">as</span><span></span><span class="token token">string</span><span class="token token punctuation">,</span><span>
</span><span>      redirect_uri</span><span class="token token operator">:</span><span></span><span class="token token constant">REDIRECT_URI</span><span class="token token punctuation">,</span><span>
</span><span>      client_id</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_ID</span><span class="token token punctuation">,</span><span>
</span><span>      client_secret</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_SECRET</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> access_token</span><span class="token token punctuation">,</span><span> id_token</span><span class="token token punctuation">,</span><span> refresh_token </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> tokenRes</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Use tokens...</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> access_token</span><span class="token token punctuation">,</span><span> id_token</span><span class="token token punctuation">,</span><span> refresh_token </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Implicit Flow

Legacy SPA flow; **not recommended** due to token exposure in URLs. Prefer Authorization Code + PKCE.

## Client Credentials Flow

Machine-to-machine flow with no user context.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">async</span><span></span><span class="token token">function</span><span></span><span class="token token">getClientToken</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">fetch</span><span class="token token punctuation">(</span><span class="token token constant">TOKEN_ENDPOINT</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    method</span><span class="token token operator">:</span><span></span><span class="token token">'POST'</span><span class="token token punctuation">,</span><span>
</span><span>    headers</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span>
</span><span>      Authorization</span><span class="token token operator">:</span><span></span><span class="token token">'Basic '</span><span></span><span class="token token operator">+</span><span> Buffer</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation constant">CLIENT_ID</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">:</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation constant">CLIENT_SECRET</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toString</span><span class="token token punctuation">(</span><span class="token token">'base64'</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token string-property property">'Content-Type'</span><span class="token token operator">:</span><span></span><span class="token token">'application/x-www-form-urlencoded'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span>    body</span><span class="token token operator">:</span><span></span><span class="token token">'grant_type=client_credentials&scope=api.read'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span></span><span class="token token punctuation">(</span><span class="token token">await</span><span> res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span>access_token</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

---

## OpenID Connect Fundamentals

## ID Token vs Access Token vs Refresh Token

| Token Type    | Purpose            | Format     | Lifetime        |
| ------------- | ------------------ | ---------- | --------------- |
| ID Token      | Authentication JWT | JWT        | Short (5–15m)  |
| Access Token  | API authorization  | JWT/Opaque | Short (minutes) |
| Refresh Token | Obtain new tokens  | Opaque/JWT | Longer (days)   |

Validate ID tokens’ `iss`, `aud`, `exp`, and `nonce` claims.

---

## PKCE for Public Clients

PKCE mitigates authorization code interception in SPAs and native apps.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">// 1. Generate code verifier & challenge</span><span>
</span><span></span><span class="token token">import</span><span> crypto </span><span class="token token">from</span><span></span><span class="token token">'crypto'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">function</span><span></span><span class="token token">generatePKCE</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> verifier </span><span class="token token operator">=</span><span> crypto</span><span class="token token punctuation">.</span><span class="token token">randomBytes</span><span class="token token punctuation">(</span><span class="token token">32</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toString</span><span class="token token punctuation">(</span><span class="token token">'hex'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> challenge </span><span class="token token operator">=</span><span> crypto</span><span class="token token punctuation">.</span><span class="token token">createHash</span><span class="token token punctuation">(</span><span class="token token">'sha256'</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">update</span><span class="token token punctuation">(</span><span>verifier</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">digest</span><span class="token token punctuation">(</span><span class="token token">'base64url'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span></span><span class="token token punctuation">{</span><span> verifier</span><span class="token token punctuation">,</span><span> challenge </span><span class="token token punctuation">}</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span>
<span></span><span class="token token">// 2. Include code_challenge & method in auth URL</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> verifier</span><span class="token token punctuation">,</span><span> challenge </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span></span><span class="token token">generatePKCE</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> params </span><span class="token token operator">=</span><span></span><span class="token token">new</span><span></span><span class="token token">URLSearchParams</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>  response_type</span><span class="token token operator">:</span><span></span><span class="token token">'code'</span><span class="token token punctuation">,</span><span>
</span><span>  client_id</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_ID</span><span class="token token punctuation">,</span><span>
</span><span>  redirect_uri</span><span class="token token operator">:</span><span></span><span class="token token constant">REDIRECT_URI</span><span class="token token punctuation">,</span><span>
</span><span>  scope</span><span class="token token operator">:</span><span></span><span class="token token">'openid'</span><span class="token token punctuation">,</span><span>
</span><span>  code_challenge</span><span class="token token operator">:</span><span> challenge</span><span class="token token punctuation">,</span><span>
</span><span>  code_challenge_method</span><span class="token token operator">:</span><span></span><span class="token token">'S256'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// 3. Exchange code with code_verifier</span><span>
</span></code></span></div></div></div></pre>

During token exchange, include `code_verifier` in the body.

---

## Social Login Integration

## Google OAuth2 Example

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">// Using passport.js</span><span>
</span><span></span><span class="token token">import</span><span> passport </span><span class="token token">from</span><span></span><span class="token token">'passport'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> Strategy </span><span class="token token">as</span><span> GoogleStrategy </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'passport-google-oauth20'</span><span class="token token punctuation">;</span><span>
</span>
<span>passport</span><span class="token token punctuation">.</span><span class="token token">use</span><span class="token token punctuation">(</span><span class="token token">new</span><span></span><span class="token token">GoogleStrategy</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>  clientID</span><span class="token token operator">:</span><span></span><span class="token token constant">GOOGLE_ID</span><span class="token token punctuation">,</span><span>
</span><span>  clientSecret</span><span class="token token operator">:</span><span></span><span class="token token constant">GOOGLE_SECRET</span><span class="token token punctuation">,</span><span>
</span><span>  callbackURL</span><span class="token token operator">:</span><span></span><span class="token token">'/auth/google/callback'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>accessToken</span><span class="token token punctuation">,</span><span> refreshToken</span><span class="token token punctuation">,</span><span> profile</span><span class="token token punctuation">,</span><span> done</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">// Find or create user in DB...</span><span>
</span><span></span><span class="token token">done</span><span class="token token punctuation">(</span><span class="token token">null</span><span class="token token punctuation">,</span><span> profile</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/google'</span><span class="token token punctuation">,</span><span> passport</span><span class="token token punctuation">.</span><span class="token token">authenticate</span><span class="token token punctuation">(</span><span class="token token">'google'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> scope</span><span class="token token operator">:</span><span></span><span class="token token punctuation">[</span><span class="token token">'openid'</span><span class="token token punctuation">,</span><span class="token token">'email'</span><span class="token token punctuation">,</span><span class="token token">'profile'</span><span class="token token punctuation">]</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/google/callback'</span><span class="token token punctuation">,</span><span> passport</span><span class="token token punctuation">.</span><span class="token token">authenticate</span><span class="token token punctuation">(</span><span class="token token">'google'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> failureRedirect</span><span class="token token operator">:</span><span></span><span class="token token">'/login'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">redirect</span><span class="token token punctuation">(</span><span class="token token">'/'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## GitHub OAuth2 Example

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">import</span><span> express </span><span class="token token">from</span><span></span><span class="token token">'express'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> router </span><span class="token token operator">=</span><span> express</span><span class="token token punctuation">.</span><span class="token token">Router</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>router</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/github'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> url </span><span class="token token operator">=</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">https://github.com/login/oauth/authorize?</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">new</span><span class="token token template-string interpolation"></span><span class="token token template-string interpolation">URLSearchParams</span><span class="token token template-string interpolation punctuation">(</span><span class="token token template-string interpolation punctuation">{</span><span class="token token template-string interpolation">
</span><span class="token token template-string interpolation">    client_id</span><span class="token token template-string interpolation operator">:</span><span class="token token template-string interpolation"></span><span class="token token template-string interpolation constant">GITHUB_ID</span><span class="token token template-string interpolation punctuation">,</span><span class="token token template-string interpolation">
</span><span class="token token template-string interpolation">    scope</span><span class="token token template-string interpolation operator">:</span><span class="token token template-string interpolation"></span><span class="token token template-string interpolation">'read:user user:email'</span><span class="token token template-string interpolation punctuation">,</span><span class="token token template-string interpolation">
</span><span class="token token template-string interpolation"></span><span class="token token template-string interpolation punctuation">}</span><span class="token token template-string interpolation punctuation">)</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">;</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">redirect</span><span class="token token punctuation">(</span><span>url</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>router</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/auth/github/callback'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> code </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>query</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> tokenRes </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">fetch</span><span class="token token punctuation">(</span><span class="token token">'https://github.com/login/oauth/access_token'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    method</span><span class="token token operator">:</span><span></span><span class="token token">'POST'</span><span class="token token punctuation">,</span><span>
</span><span>    headers</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span> Accept</span><span class="token token operator">:</span><span></span><span class="token token">'application/json'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span>    body</span><span class="token token operator">:</span><span></span><span class="token token">new</span><span></span><span class="token token">URLSearchParams</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> client_id</span><span class="token token operator">:</span><span></span><span class="token token constant">GITHUB_ID</span><span class="token token punctuation">,</span><span> client_secret</span><span class="token token operator">:</span><span></span><span class="token token constant">GITHUB_SECRET</span><span class="token token punctuation">,</span><span> code</span><span class="token token operator">:</span><span> code </span><span class="token token">as</span><span></span><span class="token token">string</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> access_token </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span></span><span class="token token">await</span><span> tokenRes</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Fetch user info...</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> access_token </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## Token Introspection & Revocation

Some OAuth 2.0 providers support introspection endpoints:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">async</span><span></span><span class="token token">function</span><span></span><span class="token token">introspect</span><span class="token token punctuation">(</span><span>token</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">fetch</span><span class="token token punctuation">(</span><span class="token token constant">INTROSPECTION_ENDPOINT</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    method</span><span class="token token operator">:</span><span></span><span class="token token">'POST'</span><span class="token token punctuation">,</span><span>
</span><span>    headers</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span>
</span><span>      Authorization</span><span class="token token operator">:</span><span></span><span class="token token">'Basic '</span><span></span><span class="token token operator">+</span><span> Buffer</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span class="token token template-string template-punctuation">`</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation constant">CLIENT_ID</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">:</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation constant">CLIENT_SECRET</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toString</span><span class="token token punctuation">(</span><span class="token token">'base64'</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token string-property property">'Content-Type'</span><span class="token token operator">:</span><span></span><span class="token token">'application/x-www-form-urlencoded'</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span>    body</span><span class="token token operator">:</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">token=</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">token</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span></span><span class="token token">// { active, scope, exp, ... }</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

Revoke tokens via revocation endpoint:

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">await</span><span></span><span class="token token">fetch</span><span class="token token punctuation">(</span><span class="token token constant">REVOCATION_ENDPOINT</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span>
</span><span>  method</span><span class="token token operator">:</span><span></span><span class="token token">'POST'</span><span class="token token punctuation">,</span><span>
</span><span>  headers</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span></span><span class="token token string-property property">'Content-Type'</span><span class="token token operator">:</span><span></span><span class="token token">'application/x-www-form-urlencoded'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span>
</span><span>  body</span><span class="token token operator">:</span><span></span><span class="token token">new</span><span></span><span class="token token">URLSearchParams</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> token</span><span class="token token operator">:</span><span> refreshToken</span><span class="token token punctuation">,</span><span> token_type_hint</span><span class="token token operator">:</span><span></span><span class="token token">'refresh_token'</span><span class="token token punctuation">,</span><span> client_id</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_ID</span><span class="token token punctuation">,</span><span> client_secret</span><span class="token token operator">:</span><span></span><span class="token token constant">CLIENT_SECRET</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## Common OAuth2 Vulnerabilities & Mitigations

1. **Authorization code interception** : Use PKCE.
2. **CSRF on auth endpoints** : Validate state parameter.
3. **Open redirectors** : Whitelist redirect URIs.
4. **Weak client secrets** : Enforce strong, rotated credentials.
5. **Token replay** : Bind tokens to client via sender-constrained tokens or MTLS.
6. **Improper scope validation** : Enforce least privilege scopes.

---

## Testing OAuth2/OIDC Implementations

## Unit Test: Token Exchange

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">import</span><span> nock </span><span class="token token">from</span><span></span><span class="token token">'nock'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> exchangeCodeForToken </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'../src/oauth'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">test</span><span class="token token punctuation">(</span><span class="token token">'exchanges code for token'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">nock</span><span class="token token punctuation">(</span><span class="token token constant">AUTH_SERVER</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/token'</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">reply</span><span class="token token punctuation">(</span><span class="token token">200</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">{</span><span> access_token</span><span class="token token operator">:</span><span></span><span class="token token">'abc'</span><span class="token token punctuation">,</span><span> id_token</span><span class="token token operator">:</span><span></span><span class="token token">'def'</span><span class="token token punctuation">,</span><span> refresh_token</span><span class="token token operator">:</span><span></span><span class="token token">'ghi'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> tokens </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">exchangeCodeForToken</span><span class="token token punctuation">(</span><span class="token token">'code123'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>tokens</span><span class="token token punctuation">.</span><span>access_token</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toBe</span><span class="token token punctuation">(</span><span class="token token">'abc'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## Integration Test: Protected Route

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">ts</div></div><div><span><code><span class="token token">import</span><span> request </span><span class="token token">from</span><span></span><span class="token token">'supertest'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> app </span><span class="token token">from</span><span></span><span class="token token">'../src/app'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">test</span><span class="token token punctuation">(</span><span class="token token">'denies without token'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">request</span><span class="token token punctuation">(</span><span>app</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/api/protected'</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>res</span><span class="token token punctuation">.</span><span>status</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toBe</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

---

## Anti-Patterns

## ❌ DON'T: Use Implicit Flow

Implicit flow exposes tokens in URL fragments; use Authorization Code + PKCE instead.

## ❌ DON'T: Hardcode Secrets

Use environment variables or vault services for client credentials.

---

This documentation provides a practical guide to implementing OAuth 2.0 and OpenID Connect patterns securely in Node.js/Express environments, with real-world code examples and defense-in-depth strategies.
