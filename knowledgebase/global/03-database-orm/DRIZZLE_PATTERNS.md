# Drizzle ORM Best Practices

Created: 2025-10-13
Last Research: 2025-10-13
Sources: Drizzle ORM documentation, observed patterns from production codebases, TypeScript integration best practices

## Overview

Drizzle ORM is a TypeScript-first ORM that prioritizes type safety and developer experience. Unlike heavy ORMs like TypeORM or Sequelize, Drizzle is lightweight and SQL-like, giving you control while maintaining type safety.

## Core Principles

1. Type safety through TypeScript - catch errors at compile time
2. SQL-like syntax - leverage SQL knowledge, don't hide complexity
3. Zero runtime overhead - generates efficient SQL
4. Schema is the source of truth
5. Zod integration for runtime validation
6. Explicit relations for type-safe joins

## Project Structure

### Recommended File Organization

```
project/
├── packages/shared-types/     # or src/db/
│   ├── schema.ts             # Table definitions
│   ├── relations.ts          # Relations (can be in schema.ts)
│   └── types.ts              # Exported types
├── config/
│   └── drizzle.config.ts     # Drizzle Kit configuration
└── migrations/               # Generated migrations
    ├── 0000_initial.sql
    └── meta/
```

## Schema Definition

### Table Definition with Identity Columns

```typescript
// TODO: Add complete table definition example
// Using pgTable, identity columns, proper types
// Based on PostgreSQL 17 recommendations

import { pgTable, text, integer, timestamp, jsonb } from "drizzle-orm/pg-core";

// Example from netzwaechter-refactored observed patterns:
// - Use GENERATED BY DEFAULT AS IDENTITY or serial
// - Always include createdAt, updatedAt
// - Use JSONB for flexible data structures
// - Define indexes inline with table definition
```

### Data Types

**Numeric:**
```typescript
// TODO: Add numeric type examples
// serial, integer, bigint, decimal, doublePrecision, real
```

**Text:**
```typescript
// TODO: Add text type examples
// text, varchar, char
```

**Temporal:**
```typescript
// TODO: Add temporal type examples
// timestamp, timestamp with time zone (timestamptz)
// Always use timestamptz for timezone-aware timestamps
```

**Boolean:**
```typescript
// TODO: Add boolean examples
// boolean with defaults
```

**JSONB:**
```typescript
// TODO: Add JSONB examples
// Type-safe JSONB with $type<T>()
// Setting defaults for JSONB columns

// Example pattern observed:
jsonb("sidebar").$type<{
  showDashboard?: boolean;
  showMaps?: boolean;
}>().default({})
```

### Defining Indexes

```typescript
// TODO: Add index definition examples
// Single column indexes
// Composite indexes
// Unique indexes
// Partial indexes
// Expression indexes

// Pattern observed:
(table) => [
  index("idx_objects_objectid").on(table.objectid),
  index("idx_objects_mandant_id").on(table.mandantId),
  index("idx_objects_type").on(table.objectType),
]
```

### Constraints

```typescript
// TODO: Add constraint examples
// Primary keys
// Foreign keys with references()
// Unique constraints
// Check constraints
// NOT NULL with notNull()
// Default values with default() and defaultNow()
```

## Relations

### Defining Relations

```typescript
// TODO: Add relation examples
// One-to-many
// Many-to-one
// Many-to-many
// Self-referencing relations

import { relations } from "drizzle-orm";

// Pattern observed from netzwaechter:
export const usersRelations = relations(users, ({ one, many }) => ({
  mandant: one(mandants, {
    fields: [users.mandantId],
    references: [mandants.id],
  }),
  settings: many(settings),
}));
```

### Relation Patterns

**One-to-Many:**
```typescript
// TODO: Add one-to-many relation example
// User has many posts
```

**Many-to-One:**
```typescript
// TODO: Add many-to-one relation example
// Post belongs to user
```

**Many-to-Many:**
```typescript
// TODO: Add many-to-many with junction table
// Students and courses via enrollments
```

**Self-Referencing:**
```typescript
// TODO: Add self-referencing relation example
// Comments with parent/child structure
```

## Type Safety with Drizzle

### Inferred Types

```typescript
// TODO: Add inferred type examples
// $inferSelect for SELECT types
// $inferInsert for INSERT types

export type User = typeof users.$inferSelect;
export type InsertUser = typeof users.$inferInsert;
```

### Zod Schema Integration

```typescript
// TODO: Add Zod integration examples
// createInsertSchema from drizzle-zod
// Extending with additional validation
// Runtime validation for API inputs

import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// Pattern observed:
export const insertMandantSchema = createInsertSchema(mandants)
  .omit({ id: true, createdAt: true })
  .extend({
    // Additional validation
  });

export type InsertMandant = z.infer<typeof insertMandantSchema>;
```

## Query Patterns

### Basic Queries

**SELECT:**
```typescript
// TODO: Add SELECT query examples
// Basic select
// Where clauses
// Ordering
// Limiting
// Selecting specific columns
```

**INSERT:**
```typescript
// TODO: Add INSERT examples
// Single row insert
// Multiple row insert
// Returning inserted data
```

**UPDATE:**
```typescript
// TODO: Add UPDATE examples
// Conditional updates
// Returning updated data
```

**DELETE:**
```typescript
// TODO: Add DELETE examples
// Conditional deletes
// Soft delete pattern
```

### Filtering with Where Clauses

```typescript
// TODO: Add where clause examples
// eq, ne, gt, gte, lt, lte
// and, or, not
// like, ilike
// inArray, notInArray
// isNull, isNotNull
// exists, notExists
```

### Joins

```typescript
// TODO: Add join examples
// innerJoin
// leftJoin
// rightJoin
// fullJoin
// Using relations for type-safe joins
```

### Aggregations

```typescript
// TODO: Add aggregation examples
// count, sum, avg, min, max
// groupBy
// having
```

### Subqueries

```typescript
// TODO: Add subquery examples
// Subqueries in WHERE clauses
// Subqueries in SELECT
// WITH (CTE) queries
```

### Transactions

```typescript
// TODO: Add transaction examples
// db.transaction()
// Rollback on error
// Nested transactions
```

See [TRANSACTIONS.md](./TRANSACTIONS.md) for detailed transaction patterns.

## Database Connection

### Connection Setup

```typescript
// TODO: Add connection setup example
// PostgreSQL with node-postgres (pg)
// Connection pooling configuration
// Environment variable usage

import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
```

### Connection Pooling

```typescript
// TODO: Add connection pool configuration
// Pool size configuration
// Timeout settings
// Connection lifecycle

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  // TODO: Add recommended pool settings
});

const db = drizzle(pool);
```

See [CONNECTION_POOLING.md](./CONNECTION_POOLING.md) for detailed pooling patterns.

## Migrations with Drizzle Kit

### Configuration

```typescript
// drizzle.config.ts
// TODO: Add complete drizzle.config.ts example
// Schema path
// Output directory
// Database credentials
// SQL dialect

import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './packages/shared-types/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    // TODO: Add credential configuration
  },
});
```

### Generating Migrations

```bash
# TODO: Add migration generation commands
# npx drizzle-kit generate:pg
# npx drizzle-kit push:pg (direct push, no migration files)
```

### Applying Migrations

```bash
# TODO: Add migration application commands
# npx drizzle-kit migrate
# Application startup migration pattern
```

### Migration Best Practices

See [SCHEMA_MIGRATIONS.md](./SCHEMA_MIGRATIONS.md) for detailed migration strategies.

## Performance Patterns

### N+1 Query Prevention

```typescript
// TODO: Add N+1 prevention examples
// Using relations with query builder
// Eager loading with .with()
// Batching queries
```

See [QUERY_OPTIMIZATION.md](./QUERY_OPTIMIZATION.md) for detailed query optimization.

### Prepared Statements

```typescript
// TODO: Add prepared statement examples
// db.query.users.findMany.prepare()
// When to use prepared statements
// Performance benefits
```

### Query Builder vs SQL

```typescript
// TODO: Add comparison examples
// When to use query builder
// When to use raw SQL with db.execute()
// Type safety with both approaches
```

## Testing Patterns

### Test Database Setup

```typescript
// TODO: Add test database setup
// Creating test database
// Running migrations
// Seeding test data
// Cleanup after tests
```

See [TESTING_DATABASE.md](./TESTING_DATABASE.md) for comprehensive testing patterns.

### Mocking Drizzle

```typescript
// TODO: Add mocking examples
// Mocking database for unit tests
// Integration test patterns
```

## Common Patterns from Production Code

### Multi-Tenancy with mandantId

```typescript
// TODO: Add multi-tenancy pattern
// mandantId foreign key
// Filtering all queries by tenant
// Row-level security alternative
```

See [MULTI_TENANCY.md](./MULTI_TENANCY.md) for detailed multi-tenancy patterns.

### JSONB for Flexible Schemas

```typescript
// TODO: Add JSONB usage patterns
// Type-safe JSONB with $type<T>()
// Setting defaults
// Querying JSONB fields
```

See [JSONB_PATTERNS.md](./JSONB_PATTERNS.md) for detailed JSONB patterns.

### Audit Columns

```typescript
// TODO: Add audit column pattern
// createdAt, updatedAt, createdBy, updatedBy
// Automatic timestamp updates
// User tracking
```

See [AUDIT_LOGGING.md](./AUDIT_LOGGING.md) for detailed audit patterns.

### Soft Deletes

```typescript
// TODO: Add soft delete pattern
// deletedAt timestamp
// Query filtering
// Cascading soft deletes
```

See [SOFT_DELETE.md](./SOFT_DELETE.md) for detailed soft delete patterns.

## Drizzle Studio

### Using Drizzle Studio

```bash
# TODO: Add Drizzle Studio usage
# npx drizzle-kit studio
# Visual schema browser
# Data exploration
```

## Anti-Patterns

### Anti-Pattern: Not Using Relations
Define relations for type-safe joins and better DX.

### Anti-Pattern: Selecting All Columns When Few Needed
Use `.select()` to specify only needed columns.

### Anti-Pattern: Not Using Transactions for Multi-Step Operations
Wrap related operations in transactions for consistency.

### Anti-Pattern: Ignoring Type Safety
Don't use `any` types - leverage Drizzle's type inference.

### Anti-Pattern: Not Using Zod Validation
Always validate input data with Zod schemas before database insertion.

### Anti-Pattern: Raw SQL Everywhere
Use the query builder for type safety, raw SQL only when necessary.

### Anti-Pattern: Not Using Connection Pooling
Always use connection pools in production. Never create new connections per request.

## Migration from Other ORMs

### From Prisma

```typescript
// TODO: Add Prisma to Drizzle migration guide
// Schema syntax differences
// Query syntax differences
// Migration strategies
```

### From TypeORM

```typescript
// TODO: Add TypeORM to Drizzle migration guide
// Decorator vs function-based schemas
// Repository pattern differences
```

## Tools and Extensions

### Drizzle Kit Commands

```bash
# TODO: Add comprehensive Drizzle Kit command reference
# generate, migrate, push, drop, studio, check
```

### IDE Integration

- TypeScript language server provides excellent autocomplete
- ESLint rules for Drizzle
- Prettier formatting for schema files

## Additional Resources

### Official Documentation
- Drizzle ORM Docs: https://orm.drizzle.team/
- Drizzle Kit Docs: https://orm.drizzle.team/kit-docs/overview
- GitHub: https://github.com/drizzle-team/drizzle-orm

### Community Resources
- Discord community
- GitHub discussions
- Example projects

### Related Knowledge Base Articles
- [Database Design](./DATABASE_DESIGN.md)
- [Schema Migrations](./SCHEMA_MIGRATIONS.md)
- [Query Optimization](./QUERY_OPTIMIZATION.md)
- [Connection Pooling](./CONNECTION_POOLING.md)
- [Testing Databases](./TESTING_DATABASE.md)
- [JSONB Patterns](./JSONB_PATTERNS.md)
- [Multi-Tenancy](./MULTI_TENANCY.md)
- [Audit Logging](./AUDIT_LOGGING.md)
- [Soft Delete](./SOFT_DELETE.md)
