# Research Result: 14_MFA_PATTERNS


# MFA PATTERNS

Created: 2025-10-14

Last Updated: 2025-10-14

## Introduction

Multi-Factor Authentication (MFA) strengthens account security by requiring users to present at least two independent credentials: something they know (password), something they have (device), or something they are (biometrics). This document outlines common MFA patterns for Node.js/Express.js applications, covering implementation, enrollment flows, recovery, and security considerations.

## 1. MFA Types

## 1.1 Time-Based One-Time Password (TOTP)

* Generates time-limited codes (e.g., 6 digits, valid for 30 seconds).
* Examples: Google Authenticator, Authy.

## 1.2 SMS/Email OTP

* Sends one-time codes via SMS or email.
* Easier to implement but susceptible to SIM swap and phishing.

## 1.3 Hardware Tokens & WebAuthn

* **Hardware keys** (e.g., YubiKey) using FIDO2/WebAuthn.
* **Platform authenticators** (Touch ID, Windows Hello).

## 2. TOTP Implementation with Speakeasy

## 2.1 Setup & Secret Generation

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span> speakeasy </span><span class="token token">from</span><span></span><span class="token token">'speakeasy'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> qrcode </span><span class="token token">from</span><span></span><span class="token token">'qrcode'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">generateTOTPSecret</span><span class="token token punctuation">(</span><span>userId</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> secret </span><span class="token token operator">=</span><span> speakeasy</span><span class="token token punctuation">.</span><span class="token token">generateSecret</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    name</span><span class="token token operator">:</span><span></span><span class="token token template-string template-punctuation">`</span><span class="token token template-string">MyApp (</span><span class="token token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token token template-string interpolation">userId</span><span class="token token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token token template-string">)</span><span class="token token template-string template-punctuation">`</span><span class="token token punctuation">,</span><span>
</span><span>    length</span><span class="token token operator">:</span><span></span><span class="token token">20</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">return</span><span></span><span class="token token punctuation">{</span><span> ascii</span><span class="token token operator">:</span><span> secret</span><span class="token token punctuation">.</span><span>ascii</span><span class="token token punctuation">,</span><span> otpauthUrl</span><span class="token token operator">:</span><span> secret</span><span class="token token punctuation">.</span><span>otpauth_url </span><span class="token token punctuation">}</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## 2.2 QR Code Generation

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">export</span><span></span><span class="token token">async</span><span></span><span class="token token">function</span><span></span><span class="token token">generateQRCode</span><span class="token token punctuation">(</span><span>otpauthUrl</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span></span><span class="token token">await</span><span> qrcode</span><span class="token token punctuation">.</span><span class="token token">toDataURL</span><span class="token token punctuation">(</span><span>otpauthUrl</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## 2.3 Verification

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">verifyTOTP</span><span class="token token punctuation">(</span><span>token</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">,</span><span> secret</span><span class="token token operator">:</span><span></span><span class="token token">string</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> speakeasy</span><span class="token token punctuation">.</span><span>totp</span><span class="token token punctuation">.</span><span class="token token">verify</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    secret</span><span class="token token punctuation">,</span><span>
</span><span>    encoding</span><span class="token token operator">:</span><span></span><span class="token token">'ascii'</span><span class="token token punctuation">,</span><span>
</span><span>    token</span><span class="token token punctuation">,</span><span>
</span><span>    window</span><span class="token token operator">:</span><span></span><span class="token token">1</span><span></span><span class="token token">// allow 1 interval before/after</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

## 3. Backup Codes

Generate one-time use backup codes for recovery when TOTP device is unavailable.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span> crypto </span><span class="token token">from</span><span></span><span class="token token">'crypto'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">generateBackupCodes</span><span class="token token punctuation">(</span><span>count </span><span class="token token operator">=</span><span></span><span class="token token">10</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span></span><span class="token token">Array</span><span class="token token punctuation">.</span><span class="token token">from</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> length</span><span class="token token operator">:</span><span> count </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">map</span><span class="token token punctuation">(</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span>
</span><span>    crypto</span><span class="token token punctuation">.</span><span class="token token">randomBytes</span><span class="token token punctuation">(</span><span class="token token">4</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toString</span><span class="token token punctuation">(</span><span class="token token">'hex'</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

* Store hashed codes in database.
* Invalidate on use.

## 4. MFA Enrollment Flow

1. **Initiate Enrollment**
   * User requests to enable MFA.
   * Generate TOTP secret and QR code.
2. **Verify Initial Code**
   * User submits TOTP code.
   * Verify with `verifyTOTP`.
3. **Save Credentials**
   * Store secret and generated backup codes.
4. **Confirm Completion**
   * Display recovery codes and require user confirmation.

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span>app</span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/mfa/setup'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> userId </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> ascii</span><span class="token token punctuation">,</span><span> otpauthUrl </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span></span><span class="token token">generateTOTPSecret</span><span class="token token punctuation">(</span><span>userId</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> qr </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">generateQRCode</span><span class="token token punctuation">(</span><span>otpauthUrl</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Persist ascii secret to user record in DB (encrypted)</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> qr </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/mfa/verify'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span></span><span class="token token punctuation">{</span><span> token</span><span class="token token punctuation">,</span><span> userSecret </span><span class="token token punctuation">}</span><span></span><span class="token token operator">=</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token">verifyTOTP</span><span class="token token punctuation">(</span><span>token</span><span class="token token punctuation">,</span><span> userSecret</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> backupCodes </span><span class="token token operator">=</span><span></span><span class="token token">generateBackupCodes</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">// Hash & save backupCodes to DB</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">,</span><span> backupCodes </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span></span><span class="token token">else</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">400</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">,</span><span> message</span><span class="token token operator">:</span><span></span><span class="token token">'Invalid token'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 5. MFA Enforcement Middleware

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> Request</span><span class="token token punctuation">,</span><span> Response</span><span class="token token punctuation">,</span><span> NextFunction </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'express'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">export</span><span></span><span class="token token">function</span><span></span><span class="token token">requireMFA</span><span class="token token punctuation">(</span><span>req</span><span class="token token operator">:</span><span> Request</span><span class="token token punctuation">,</span><span> res</span><span class="token token operator">:</span><span> Response</span><span class="token token punctuation">,</span><span> next</span><span class="token token operator">:</span><span> NextFunction</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span>req</span><span class="token token punctuation">.</span><span>user</span><span class="token token operator">?.</span><span>mfaEnabled</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">403</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> message</span><span class="token token operator">:</span><span></span><span class="token token">'MFA required'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span>req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>mfaPassed</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> message</span><span class="token token operator">:</span><span></span><span class="token token">'MFA verification required'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token">next</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span></code></span></div></div></div></pre>

* Apply to sensitive routes: account settings, transactions.

## 6. Recovery Mechanisms and Bypass Protection

## 6.1 Backup Codes Usage

* Allow backup code once, then immediately invalidate.
* Require password re-entry before using backup code.

## 6.2 Email/SMS OTP Fallback

* As a secondary factor only if TOTP unavailable.
* Rate-limit requests and revoke codes after short window (5 minutes).

## 6.3 Admin Bypass Protection

* Implement “break glass” only with multi-admin approval.
* Log all bypass attempts and notify security team.

## 7. WebAuthn / FIDO2 Integration

## 7.1 Registration (Credential Creation)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> generateRegistrationOptions </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'@simplewebauthn/server'</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/webauthn/register'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> options </span><span class="token token operator">=</span><span></span><span class="token token">generateRegistrationOptions</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    rpName</span><span class="token token operator">:</span><span></span><span class="token token">'MyApp'</span><span class="token token punctuation">,</span><span>
</span><span>    userID</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>user</span><span class="token token punctuation">.</span><span>id</span><span class="token token punctuation">,</span><span>
</span><span>    userName</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>user</span><span class="token token punctuation">.</span><span>email</span><span class="token token punctuation">,</span><span>
</span><span>    attestationType</span><span class="token token operator">:</span><span></span><span class="token token">'indirect'</span><span class="token token punctuation">,</span><span>
</span><span>    authenticatorSelection</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span>
</span><span>      userVerification</span><span class="token token operator">:</span><span></span><span class="token token">'preferred'</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>  req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>challenge </span><span class="token token operator">=</span><span> options</span><span class="token token punctuation">.</span><span>challenge</span><span class="token token punctuation">;</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span>options</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 7.2 Verification

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> verifyRegistrationResponse </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'@simplewebauthn/server'</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/webauthn/register'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> verification </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">verifyRegistrationResponse</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    credential</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">,</span><span>
</span><span>    expectedChallenge</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>challenge</span><span class="token token punctuation">,</span><span>
</span><span>    expectedOrigin</span><span class="token token operator">:</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">WEBAUTHN_ORIGIN</span><span class="token token operator">!</span><span class="token token punctuation">,</span><span>
</span><span>    expectedRPID</span><span class="token token operator">:</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">WEBAUTHN_RPID</span><span class="token token operator">!</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>verification</span><span class="token token punctuation">.</span><span>verified</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">// Store credentialPublicKey and credentialID in user record</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">true</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span></span><span class="token token">else</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">400</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">false</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 7.3 Authentication Flow

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span></span><span class="token token punctuation">{</span><span> generateAuthenticationOptions</span><span class="token token punctuation">,</span><span> verifyAuthenticationResponse </span><span class="token token punctuation">}</span><span></span><span class="token token">from</span><span></span><span class="token token">'@simplewebauthn/server'</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">get</span><span class="token token punctuation">(</span><span class="token token">'/webauthn/authenticate'</span><span class="token token punctuation">,</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> options </span><span class="token token operator">=</span><span></span><span class="token token">generateAuthenticationOptions</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    allowCredentials</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>user</span><span class="token token punctuation">.</span><span>credentials</span><span class="token token punctuation">.</span><span class="token token">map</span><span class="token token punctuation">(</span><span>c </span><span class="token token operator">=></span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>      id</span><span class="token token operator">:</span><span> c</span><span class="token token punctuation">.</span><span>credentialID</span><span class="token token punctuation">,</span><span>
</span><span>      type</span><span class="token token operator">:</span><span></span><span class="token token">'public-key'</span><span class="token token punctuation">,</span><span>
</span><span>      transports</span><span class="token token operator">:</span><span></span><span class="token token punctuation">[</span><span class="token token">'usb'</span><span class="token token punctuation">,</span><span class="token token">'ble'</span><span class="token token punctuation">,</span><span class="token token">'nfc'</span><span class="token token punctuation">]</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span>
</span><span>    userVerification</span><span class="token token operator">:</span><span></span><span class="token token">'preferred'</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span>  req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>challenge </span><span class="token token operator">=</span><span> options</span><span class="token token punctuation">.</span><span>challenge</span><span class="token token punctuation">;</span><span>
</span><span>  res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span>options</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>
<span>app</span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/webauthn/authenticate'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span>req</span><span class="token token punctuation">,</span><span> res</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">const</span><span> verification </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">verifyAuthenticationResponse</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span>
</span><span>    credential</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">,</span><span>
</span><span>    expectedChallenge</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>challenge</span><span class="token token punctuation">,</span><span>
</span><span>    expectedOrigin</span><span class="token token operator">:</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">WEBAUTHN_ORIGIN</span><span class="token token operator">!</span><span class="token token punctuation">,</span><span>
</span><span>    expectedRPID</span><span class="token token operator">:</span><span> process</span><span class="token token punctuation">.</span><span>env</span><span class="token token punctuation">.</span><span class="token token constant">WEBAUTHN_RPID</span><span class="token token operator">!</span><span class="token token punctuation">,</span><span>
</span><span>    authenticator</span><span class="token token operator">:</span><span> req</span><span class="token token punctuation">.</span><span>user</span><span class="token token punctuation">.</span><span>credentials</span><span class="token token punctuation">.</span><span class="token token">find</span><span class="token token punctuation">(</span><span>c </span><span class="token token operator">=></span><span> c</span><span class="token token punctuation">.</span><span>credentialID </span><span class="token token operator">===</span><span> req</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">.</span><span>id</span><span class="token token punctuation">)</span><span class="token token operator">!</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>verification</span><span class="token token punctuation">.</span><span>verified</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    req</span><span class="token token punctuation">.</span><span>session</span><span class="token token punctuation">.</span><span>mfaPassed </span><span class="token token operator">=</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">;</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">true</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span></span><span class="token token">else</span><span></span><span class="token token punctuation">{</span><span>
</span><span>    res</span><span class="token token punctuation">.</span><span class="token token">status</span><span class="token token punctuation">(</span><span class="token token">401</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">json</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> success</span><span class="token token operator">:</span><span></span><span class="token token boolean">false</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## 8. Security Considerations & Common Pitfalls

* **Secret Storage:** Encrypt TOTP secrets and WebAuthn credentials at rest.
* **Rate Limiting:** Limit TOTP, SMS, and WebAuthn attempts to prevent brute force.
* **Clock Drift:** Allow small token windows (±1 interval).
* **Backup Code Leakage:** Store only hashed codes; display once to user.
* **SMS Risks:** SIM swap attacks; prefer TOTP or hardware keys.
* **Session Management:** Invalidate sessions on MFA state changes.
* **Logging & Monitoring:** Log enrollment, verification, bypass events for audit.

## 9. Testing MFA Flows

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded font-mono text-sm font-normal bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end md:sticky md:top-[100px]"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"><button data-testid="toggle-wrap-code-button" aria-label="Wrap lines" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l16 0 M4 18l5 0 M4 12h13a3 3 0 0 1 0 6h-4l2 -2m0 4l-2 -2"></path></svg></div></div></button><button data-testid="copy-code-button" aria-label="Copy code" type="button" class="focus-visible:bg-subtle hover:bg-subtle text-quiet  hover:text-foreground dark:hover:bg-subtle font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out select-none items-center relative group/button font-semimedium justify-center text-center items-center rounded-full cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-square" data-state="closed"><div class="flex items-center min-w-0 gap-two justify-center"><div class="flex shrink-0 items-center justify-center size-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" color="currentColor" class="tabler-icon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path></svg></div></div></button></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-[3px] font-thin">typescript</div></div><div><span><code><span class="token token">import</span><span> request </span><span class="token token">from</span><span></span><span class="token token">'supertest'</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">import</span><span> app </span><span class="token token">from</span><span></span><span class="token token">'../src/app'</span><span class="token token punctuation">;</span><span>
</span>
<span></span><span class="token token">test</span><span class="token token punctuation">(</span><span class="token token">'TOTP verification succeeds with valid token'</span><span class="token token punctuation">,</span><span></span><span class="token token">async</span><span></span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span></span><span class="token token operator">=></span><span></span><span class="token token punctuation">{</span><span>
</span><span></span><span class="token token">// Arrange: generate secret and token</span><span>
</span><span></span><span class="token token">const</span><span> secret </span><span class="token token operator">=</span><span> speakeasy</span><span class="token token punctuation">.</span><span class="token token">generateSecret</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> length</span><span class="token token operator">:</span><span></span><span class="token token">20</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span>ascii</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token">const</span><span> token </span><span class="token token operator">=</span><span> speakeasy</span><span class="token token punctuation">.</span><span class="token token">totp</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> secret</span><span class="token token punctuation">,</span><span> encoding</span><span class="token token operator">:</span><span></span><span class="token token">'ascii'</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>  
<span></span><span class="token token">// Act</span><span>
</span><span></span><span class="token token">const</span><span> res </span><span class="token token operator">=</span><span></span><span class="token token">await</span><span></span><span class="token token">request</span><span class="token token punctuation">(</span><span>app</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">post</span><span class="token token punctuation">(</span><span class="token token">'/mfa/verify'</span><span class="token token punctuation">)</span><span>
</span><span></span><span class="token token punctuation">.</span><span class="token token">send</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> token</span><span class="token token punctuation">,</span><span> userSecret</span><span class="token token operator">:</span><span> secret </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span>  
<span></span><span class="token token">// Assert</span><span>
</span><span></span><span class="token token">expect</span><span class="token token punctuation">(</span><span>res</span><span class="token token punctuation">.</span><span>body</span><span class="token token punctuation">.</span><span>success</span><span class="token token punctuation">)</span><span class="token token punctuation">.</span><span class="token token">toBe</span><span class="token token punctuation">(</span><span class="token token boolean">true</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span><span></span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></code></span></div></div></div></pre>

## References

* OWASP Multi-Factor Authentication Cheat Sheet
* RFC 6238: TOTP
* Speakeasy npm Docs
* WebAuthn FIDO2 Specification
* securityheaders.com

> End of MFA_PATTERNS.md (approx. 350 lines)
>
